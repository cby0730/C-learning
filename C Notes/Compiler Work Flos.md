# 編譯流程

# **C++ 的編譯流程**

C++ 的編譯流程主要分為四個階段：預處理、編譯、組譯和連結。在每個階段，程式碼會經過不同的處理，並對各種語言特性進行解析和轉換。以下將依照這些階段，詳細說明在每個階段中會處理哪些事情，以及關鍵詞如 `macro`、`inline`、`static`、`const`、`extern` 等是如何被處理的。

## **預處理（Preprocessing）**

### **處理預處理指令**

- **展開 `#include` 頭文件：**
    - 將被包含的頭文件內容直接插入到包含指令的位置。
- **替換 `#define` 定義的巨集（`Macro`）：**
    - 將所有出現的`macro`名稱替換為其定義的內容。
- **處理條件編譯指令，如 `#if`、`#ifdef`、`#ifndef` 等：**
    - 根據條件編譯指令的結果，決定哪些程式碼被保留，哪些被忽略。

### **在這個階段處理的關鍵詞和特性**

- **`macro`（巨集）**
    - 所有的`macro`定義和替換在此階段完成，包括函數式`macro`和物件式`macro`。
- **條件編譯相關指令：**
    - 控制程式碼的編譯，根據定義的符號來決定程式碼的包含與否。

### **結果**

- 生成預處理後的程式碼，所有的`macro`和預處理指令都已被展開或處理，形成一個乾淨的原始程式碼，準備進入編譯階段。

## **編譯（Compilation）**

### **語法與語義分析：**

- **解析程式碼的語法結構：**
    - 編譯器檢查程式碼是否符合 C++ 的語法規則，構建抽象語法樹（AST）。
- **檢查語義正確性：**
    - 確認變量和函數的定義與使用是否一致，類型轉換是否合法等。

### **處理特定的語言特性：**

- **`inline` 函數：**
    - 編譯器在適當的情況下將 `inline` 函數的呼叫展開為函數體，減少函數呼叫的開銷。
- **`const` 常量：**
    - 編譯器處理 `const` 修飾的變量，確保其不可被修改，並可能進行常量折疊等優化。
- **`static` 變量與函數：**
    - 對於在函數內部宣告的 `static` 變量，編譯器確定其在程序執行期間的唯一性和持久性。
    - 對於文件範圍的 `static` 變量和函數，編譯器設定其內部連結性，使其不可被其他翻譯單元訪問。
- **`extern` 關鍵字：**
    - 標識外部定義的變量或函數，編譯器記錄這些符號，等待連結階段進行解析。

### **生成組合語言：**

- 將高階的 C++ 程式碼轉換為對應的組合語言指令，準備進行組譯。

### **優化：**

- **代碼優化：**
    - 編譯器在不改變程式碼語意的前提下，進行各種優化，如：
        - **常量傳播和折疊：**
            - 將計算結果為已知的表達式直接替換為結果值。
        - **死代碼消除：**
            - 移除不會被執行的程式碼。
        - **循環優化：**
            - 優化循環結構，提高執行效率。

### **結果：**

- 生成經過優化的組合語言程式碼，包含了所有語言特性的實現細節。

## **組譯（Assembly）：**

### **將組合語言程式碼轉換為目標代碼：**

- 組譯器（Assembler）將人類可讀的組合語言指令轉換為機器碼，即 CPU 可以直接執行的二進制指令。

### **符號表的建立：**

- **內部和外部符號：**
    - 將 `static` 修飾的符號標記為內部符號，不導出給其他目標文件。
    - 將 `extern` 聲明的符號標記為未解析的外部符號，等待連結階段解析。

### **結果：**

- 生成目標檔案（.o 或 .obj），其中包含機器碼和符號表，符號表中記錄了所有的全局符號和未解析的外部符號。

## **連結（Linking）：**

### **符號解析與重定位：**

- **解析外部符號：**
    - 連結器（Linker）將所有目標檔案和庫中的符號進行匹配，解析 `extern` 聲明的符號。
- **處理 `static` 和 `extern`：**
    - `static` 符號因為具有內部連結性，不會被導出或在其他目標檔案中查找。
    - `extern` 符號需要在其他目標檔案或庫中找到定義。

### **組合所有目標檔案和庫：**

- 將各個目標檔案中的機器碼和數據段整合，調整地址和偏移，以形成完整的可執行檔案。

### **結果：**

- 生成最終的可執行檔案，所有符號都已解析，機器碼可以直接在目標環境中執行。

### **在這個階段處理的關鍵詞和特性：**

- **`static` 的連結性：**
    - 確保 `static` 符號不被其他翻譯單元訪問，維持符號的內部連結性。
- **`extern` 符號的解析：**
    - 將所有 `extern` 符號與其定義進行匹配，解決跨文件的符號引用。

---

**總結：**

- **預處理階段：**
    - 處理所有的預處理指令，包括`macro`替換和條件編譯。
    - 關鍵詞：`#define`、`#include`、`#if`、`#ifdef` 等。
- **編譯階段：**
    - 進行語法和語義分析，處理 C++ 語言特性。
    - 關鍵詞：`inline`、`const`、`static`、`extern` 等在此階段被解析，其語意被確定。
- **組譯階段：**
    - 將組合語言轉換為機器碼，建立符號表。
    - 確定符號的連結性，為連結階段做準備。
- **連結階段：**
    - 解析所有外部符號，將目標檔案和庫整合為可執行檔案。
    - 處理符號的可見性和連結性，最終生成可執行的機器碼。